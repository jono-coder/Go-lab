START TRANSACTION;

### player_entity ###
CREATE OR REPLACE TABLE `player_entity` (
    `id` INT AUTO_INCREMENT PRIMARY KEY,
    `resource_id` VARCHAR(100) NOT NULL
        CHECK(TRIM(`resource_id`) <> ''),
    `name` VARCHAR(50) NOT NULL
        CHECK(TRIM(`name`) <> ''),
    `description` VARCHAR(50)
        CHECK(TRIM(description) <> ''),
    `last_checkin` TIMESTAMP
        CHECK(`last_checkin` >= created_at),
    `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `created_by` INT NOT NULL DEFAULT COALESCE(@session_user_id, 0),
    `updated_at` TIMESTAMP(6),
    `updated_by` INT,
    `deleted` BIT NOT NULL DEFAULT 0
);

INSERT INTO `player_entity` (`resource_id`, `name`, `description`)
SELECT `vals`.`resource_id`, `vals`.`name`, `vals`.`description`
FROM (
    SELECT 'abcd1234' AS `resource_id`, 'Player One' AS `name`, '1st example player' AS `description`
    UNION ALL
    SELECT 'defg5678', 'Player Two', '2nd example player'
) AS `vals`
WHERE NOT EXISTS (SELECT 1 FROM `player_entity` LIMIT 1);

CREATE TRIGGER `trg_player_bu_update_by_at`
    BEFORE UPDATE
    ON `player_entity` FOR EACH ROW
BEGIN

SET NEW.`updated_by` = @session_user_id;
SET NEW.`updated_at` = CURRENT_TIMESTAMP(6);

END;
### player_entity ###

### functions ###
CREATE OR REPLACE FUNCTION `get_current_user_id`()
RETURNS INT
READS SQL DATA
DETERMINISTIC
RETURN @session_user_id;
### functions ###

COMMIT;
