START TRANSACTION;

### player_entity ###
DROP TABLE IF EXISTS `player_entity`;

CREATE TABLE `player_entity` (
    `id` INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    `resource_id` VARCHAR(100) NOT NULL
        CHECK(TRIM(`resource_id`) <> ''),
    `name` VARCHAR(50) NOT NULL
        CHECK(TRIM(`name`) <> ''),
    `description` VARCHAR(50)
        CHECK(TRIM(`description`) <> ''),
    `last_checkin` TIMESTAMP
        CHECK(`last_checkin` >= `created_at`),
    `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `created_by` INT NOT NULL DEFAULT COALESCE(@session_user_id, 0),
    `updated_at` TIMESTAMP(6),
    `updated_by` INT,
    `deleted_at` TIMESTAMP
) DEFAULT CHARSET=utf8mb4;

INSERT INTO `player_entity` (`resource_id`, `name`, `description`)
VALUES
    ('abcd1234', 'Player One', '1st example player'),
    ('defg5678', 'Player Two', '2nd example player');

CREATE INDEX `idx_player_resource_id` ON `player_entity` (`resource_id`);

CREATE OR REPLACE TRIGGER `trg_player_bu_update_by_at`
    BEFORE UPDATE
    ON `player_entity` FOR EACH ROW
BEGIN
    SET NEW.`updated_by` = @session_user_id;
    SET NEW.`updated_at` = CURRENT_TIMESTAMP(6);
END;

CREATE OR REPLACE TRIGGER `trg_player_disable_delete`
    BEFORE DELETE
    ON `player_entity` FOR EACH ROW
BEGIN
    SIGNAL SQLSTATE '45000'
    SET MESSAGE_TEXT = 'Deletes are forbidden';
END;
### player_entity ###

### audit ###
DROP TABLE IF EXISTS `audit_log`;
DROP TABLE IF EXISTS `audit_table`;

CREATE TABLE `audit_table` (
   `id` INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
   `name` VARCHAR(50) NOT NULL
        CHECK(TRIM(`name`) <> ''),
   UNIQUE KEY `audit_table_unique_name` (`name`)
) DEFAULT CHARSET=utf8mb4;

CREATE TABLE `audit_log` (
    `id` INT UNSIGNED AUTO_INCREMENT,
    `table_id` INT UNSIGNED NOT NULL,
    `action` ENUM ("INSERT","UPDATE","DELETE") NOT NULL,
    `performed_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `performed_by` INT NOT NULL,
    PRIMARY KEY (`id`, `performed_at`)
) DEFAULT CHARSET=utf8mb4
PARTITION BY RANGE (TO_DAYS(`performed_at`)) (
    PARTITION p202412 VALUES LESS THAN (TO_DAYS('2025-01-01')),
    PARTITION p202501 VALUES LESS THAN (TO_DAYS('2025-02-01')),
    PARTITION p202502 VALUES LESS THAN (TO_DAYS('2025-03-01')),
    PARTITION p202503 VALUES LESS THAN (TO_DAYS('2025-04-01')),
    PARTITION pMax VALUES LESS THAN MAXVALUE
);

# shows how to add new partitions #
ALTER TABLE `audit_log` DROP PARTITION pMax;

ALTER TABLE `audit_log`
    ADD PARTITION (
        PARTITION p202504 VALUES LESS THAN (TO_DAYS('2025-05-01')),
        PARTITION p202505 VALUES LESS THAN (TO_DAYS('2025-06-01')),
        PARTITION pMax VALUES LESS THAN MAXVALUE
    );
# shows how to add new partitions #

CREATE INDEX `idx_audit_log_table_id_action` USING BTREE ON `audit_log` (`table_id`, `action`);

CREATE OR REPLACE TRIGGER `trg_audit_table_disable_delete`
BEFORE DELETE
ON `audit_table` FOR EACH ROW
BEGIN
    SIGNAL SQLSTATE '45000'
    SET MESSAGE_TEXT = 'Deletes are forbidden';
END;

CREATE OR REPLACE TRIGGER `trg_audit_log_bi_performed_by`
BEFORE INSERT
ON `audit_log` FOR EACH ROW
BEGIN
    IF NEW.performed_by IS NULL THEN
        SET NEW.performed_by = COALESCE(@session_user_id, 0);
    END IF;
END;

CREATE OR REPLACE TRIGGER `trg_audit_log_disable_update`
BEFORE UPDATE
ON `audit_log` FOR EACH ROW
BEGIN
    SIGNAL SQLSTATE '45000'
    SET MESSAGE_TEXT = 'Audit log rows are immutable (UPDATE is forbidden)';
END;

CREATE OR REPLACE TRIGGER `trg_audit_log_disable_delete`
BEFORE DELETE
ON `audit_log` FOR EACH ROW
BEGIN
    SIGNAL SQLSTATE '45000'
    SET MESSAGE_TEXT = 'Audit log rows are immutable (DELETE is forbidden)';
END;

### audit ###

### functions ###
CREATE OR REPLACE FUNCTION `get_current_user_id`()
RETURNS INT
READS SQL DATA
DETERMINISTIC
RETURN @session_user_id;
### functions ###

COMMIT;
